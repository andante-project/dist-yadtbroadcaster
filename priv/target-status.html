<html>
  <head>
    <link type="text/css" rel="stylesheet" href="yadt.css"></link>
    <style>
      .fa-exclamation-triangle { color: red; }
      .fa-check-circle { color: green; }
    </style>
    <script src="jquery.min.js"></script>
    <script src="d3.min.js"></script>
    <script>
      $.extend({
          getUrlVars: function(){
              var vars = [], hash;
              var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
              for(var i = 0; i < hashes.length; i++) {
                  hash = hashes[i].split('=');
                  vars.push(hash[0]);
                  vars[hash[0]] = hash[1];
              }
              return vars;
          },
          getUrlVar: function(name){
              return $.getUrlVars()[name];
          }
      });
    </script>
  </head>
  <body>
  <h1>Target <span class="targetname"></span></h1>
  <div id="hosts">
  </div>

    <script>
      var target = $.getUrlVar('target');
      var url = "/types/targets/buckets/" + target + "/keys/hosts";
      d3.select(".targetname").text(target);

      var model = [];
      $.ajax({url: url,
        type: "GET",
        contentType: 'text/plain'
      })
        .done(function(data, status){
            console.log(data);
            data.split("\n").forEach(function(host) {
              $.get("/types/hosts/buckets/" + host + "/keys/services")
                .done(function(services, status) {
                  console.log(services);
                  var host_model = {"name": host, "services": []};
                  model.push(host_model);
                  services.split("\n").forEach(function(service){
                    $.get("/types/services/buckets/" + host + "/keys/" + service)
                      .done(function(state, status) {
                        host_model.services.push(service + ": " + state);
                        var view = d3.select("#hosts").selectAll("div").data(model);
                        view.enter().append("div").append("h2").text(function(d){return d.name;});
                        var services = view.selectAll("p").data(function(d){return d.services;});
                        services.enter().append("p").text(function(d){return d;});
                        })
                      .fail(function(xhr, status) {
                        console.log(xhr);
                        console.log(status);
                        });
                  })
                })
                .fail(function(xhr, status) {
                  console.log(xhr);
                  console.log(status);
                });
              });
        })
        .fail(function(xhr, status){
            console.log(xhr);
            console.log(status);
        });
    </script>
  </body>
</html>
